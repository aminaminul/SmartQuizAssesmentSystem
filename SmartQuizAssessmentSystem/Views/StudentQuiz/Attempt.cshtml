@using QuizSystemModel.Models
@model QuizAttempt

@{
    ViewData["Title"] = "Quiz Attempt";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var questions = Model.Answers
        .OrderBy(a => a.QuestionBank.Id)
        .ToList();

    var durationSeconds = Model.Quiz.Duration.HasValue
        ? (int)Model.Quiz.Duration.Value.TotalSeconds
        : 0;
}

<h2>@Model.Quiz.Name</h2>
<p><strong>Subject:</strong> @Model.Quiz.Subject</p>
@if (durationSeconds > 0)
{
    <p><strong>Time Remaining:</strong> <span id="timer"></span></p>
}

<div class="row">
    <div class="col-md-3">
        <h5>Questions</h5>
        <div class="list-group" id="question-nav">
            @for (int i = 0; i < questions.Count; i++)
            {
                <button type="button"
                        class="list-group-item list-group-item-action"
                        data-question-index="@i">
                    Question @(i + 1)
                </button>
            }
        </div>
    </div>

    <div class="col-md-9">
        <form asp-controller="StudentQuiz"
              asp-action="Submit"
              method="post"
              id="quizForm">
            @Html.AntiForgeryToken()
            <input type="hidden" name="attemptId" value="@Model.Id" />

            @for (int i = 0; i < questions.Count; i++)
            {
                var a = questions[i];
                var q = a.QuestionBank;
                string groupName = $"answers[{i}].SelectedOption";

                <div class="question-panel" data-question-index="@i" style="display:@(i == 0 ? "block" : "none")">
                    <h5>Question @(i + 1)</h5>
                    <p>@q.QuestionText</p>

                    <input type="hidden" name="answers[@i].QuestionBankId" value="@q.Id" />
                    <input type="hidden" name="answers[@i].QuizAttemptId" value="@Model.Id" />

                    <div class="form-check">
                        <input class="form-check-input option-input"
                               type="radio"
                               name="@groupName"
                               value="A"
                               data-question-id="@q.Id" />
                        <label class="form-check-label">A. @q.OptionA</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input option-input"
                               type="radio"
                               name="@groupName"
                               value="B"
                               data-question-id="@q.Id" />
                        <label class="form-check-label">B. @q.OptionB</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input option-input"
                               type="radio"
                               name="@groupName"
                               value="C"
                               data-question-id="@q.Id" />
                        <label class="form-check-label">C. @q.OptionC</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input option-input"
                               type="radio"
                               name="@groupName"
                               value="D"
                               data-question-id="@q.Id" />
                        <label class="form-check-label">D. @q.OptionD</label>
                    </div>

                    <div class="mt-3">
                        <button type="button" class="btn btn-secondary btn-sm prev-btn">Previous</button>
                        <button type="button" class="btn btn-secondary btn-sm next-btn">Next</button>
                    </div>
                </div>
            }

            <div class="mt-4">
                <button type="submit" class="btn btn-success">
                    Submit Quiz
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        // Question Navigation
        (function () {
            const panels = document.querySelectorAll('.question-panel');
            const navButtons = document.querySelectorAll('#question-nav button');

            function showQuestion(index) {
                panels.forEach(p => p.style.display = 'none');
                navButtons.forEach(b => b.classList.remove('active'));
                const panel = document.querySelector(`.question-panel[data-question-index='${index}']`);
                const nav = document.querySelector(`#question-nav button[data-question-index='${index}']`);
                if (panel) panel.style.display = 'block';
                if (nav) nav.classList.add('active');
            }

            navButtons.forEach(btn => {
                btn.addEventListener('click', function () {
                    const idx = this.getAttribute('data-question-index');
                    showQuestion(idx);
                });
            });

            document.querySelectorAll('.next-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const panel = this.closest('.question-panel');
                    const idx = parseInt(panel.getAttribute('data-question-index'));
                    if (idx + 1 < panels.length) showQuestion(idx + 1);
                });
            });

            document.querySelectorAll('.prev-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const panel = this.closest('.question-panel');
                    const idx = parseInt(panel.getAttribute('data-question-index'));
                    if (idx - 1 >= 0) showQuestion(idx - 1);
                });
            });

            showQuestion(0);
        })();

        (function () {
            const attemptId = @Model.Id;

            document.querySelectorAll('.option-input').forEach(input => {
                input.addEventListener('change', function () {
                    const questionId = this.getAttribute('data-question-id');
                    const selectedOption = this.value;

                    fetch('@Url.Action("Autosave", "StudentQuiz")', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                        },
                        body: `attemptId=${attemptId}&questionId=${questionId}&selectedOption=${selectedOption}`
                    });
                });
            });
        })();

        // Timer
        (function () {
            const totalSeconds = @durationSeconds;
            if (!totalSeconds || totalSeconds <= 0) return;

            const start = new Date('@Model.StartAt.ToUniversalTime().ToString("o")');
            const end = new Date(start.getTime() + totalSeconds * 1000);

            function updateTimer() {
                const now = new Date();
                let remaining = Math.floor((end - now) / 1000);
                if (remaining <= 0) {
                    document.getElementById('timer').innerText = '00:00';
                    document.getElementById('quizForm').submit();
                    return;
                }
                const m = Math.floor(remaining / 60);
                const s = remaining % 60;
                document.getElementById('timer').innerText =
                    `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            }

            updateTimer();
            setInterval(updateTimer, 1000);
        })();
    </script>
}
